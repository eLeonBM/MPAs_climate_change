library(sp)
library(tidyverse)
library(rnaturalearth)
library(ggthemes)
library(patchwork)
library(sf)


#Load data----
mpa_data <- sf::st_read("Data/shapefiles/outputs/mpa_variables.shp")
names(mpa_data)

#Add missing values for hw_slope

missing <- read.csv("Data/missing_heatwaves.csv")
missing <- missing %>% 
        rename(men_slp= X_mean)
mpa_data$men_slp[match(missing$ID, mpa_data$ID)] <- missing$men_slp

info <- mpa_data %>% 
        as.data.frame() %>% 
        select(-geometry) %>% 
        rename(
                habitat = type,
                coldcorals= cldcrls,
                seagrass = segrsss,
                warmcorals = wrmcrls,
                seamounts = seamnts,
                hw_slope = men_slp,
        ) %>% 
        select( ID,NOMBRE,habitat,coldcorals,seagrass,seamounts, knolls,hw_slope)

#Scoring variables----


score <- mpa_data %>%
        as.data.frame() %>% 
        #Scoring kelp
        mutate(kelp = replace(kelp, kelp > 0 & kelp <= 1 , 5),
               kelp = replace(kelp, kelp == 0, 1)) %>%
        mutate(cldcrls= replace(cldcrls, cldcrls >= 0 & cldcrls <=2, 1),
               cldcrls= replace(cldcrls, cldcrls > 8 & cldcrls <= 10, 5)) %>% 
        #Seagrass
        mutate( segrsss = replace(segrsss, segrsss > 2.4 & segrsss <= 3, 5),
                segrsss = replace(segrsss, segrsss > 1.8 & segrsss <= 2.4, 4),
                segrsss = replace(segrsss, segrsss > 1.2 & segrsss <= 1.8, 3),
                segrsss = replace(segrsss, segrsss > 0.6 & segrsss <= 1.2, 2),
                segrsss = replace(segrsss, segrsss >= 0 &  segrsss <= 0.6, 1)) %>%
        #Warm corals
        mutate(wrmcrls = replace(wrmcrls, wrmcrls >= 0 &
                                         wrmcrls <= 3, 100),
               wrmcrls = replace(wrmcrls, wrmcrls > 3 &
                                         wrmcrls <= 6, 200),
               wrmcrls = replace(wrmcrls, wrmcrls > 6 &
                                         wrmcrls <= 9, 300),
               wrmcrls = replace(wrmcrls, wrmcrls > 9 &
                                         wrmcrls <= 12, 400),
               wrmcrls = replace(wrmcrls, wrmcrls > 12 &
                                         wrmcrls <= 15, 500),
               wrmcrls = wrmcrls / 100) %>%
        #Seamounts
        mutate(seamnts = replace(seamnts, seamnts >= 0 &
                                         seamnts <= 8.6, 100),
               seamnts = replace(seamnts, seamnts > 8.6 &
                                         seamnts <= 17.2, 200),
               seamnts = replace(seamnts, seamnts > 17.2 &
                                         seamnts <= 25.8, 300),
               seamnts = replace(seamnts, seamnts > 25.8 &
                                         seamnts <= 34.4, 400),
               seamnts = replace(seamnts, seamnts > 34.4 &
                                         seamnts <= 43, 500),
               seamnts = seamnts / 100) %>%
        #knolls
        mutate(knolls = replace(knolls, knolls >= 0 &
                                        knolls <= 36.4, 100),
               knolls = replace(knolls, knolls > 36.4 &
                                        knolls <= 72.8, 200),
               knolls = replace(knolls, knolls > 145.6 &
                                        knolls <= 182, 500),
               knolls = knolls / 100) %>%
        #Heatwaves (Mean Slope)
        mutate(men_slp = replace(men_slp, men_slp >= 0 &
                                         men_slp <= 0.010704066, 1),
               men_slp = replace(men_slp, men_slp > 0.010704066 &
                                         men_slp <= 0.021408132, 2),
               men_slp = replace(men_slp, men_slp > 0.021408132 &
                                         men_slp <= 0.032112198, 3),
               men_slp = replace(men_slp, men_slp > 0.032112198 &
                                         men_slp <= 0.042816264, 4),
               men_slp = replace(men_slp, men_slp > 0.042816264 &
                                         men_slp <= 0.05352033, 5),
               men_slp = replace(men_slp, men_slp >= 0.05352033 &
                                         men_slp < 0.06, 5)) %>%
        #Habitat
        mutate(type = replace(type, type == "atoll", 5),
               type = replace(type, type == "beach", 4),
               type = replace (type, type == "estuaries", 3),
               type = replace(type, type == "cliff", 2),
               type = replace(type, type == "ocean", 1)) %>%
        #Rename columns
         rename(
                habitat = type,
                coldcorals= cldcrls,
                seagrass = segrsss,
                warmcorals = wrmcrls,
                seamounts = seamnts,
                hw_slope = men_slp,
        )


#Delete extra columns and remove NAs
score <- score %>% 
        select(-c("ESTADOS","MUNICIP","REGION","SUPERFI","mn_htwv", "geometry" ))
score <- score[!is.na(score$habitat), ]




#Calculate CVI values
cvi <- score %>%
        transform(habitat = as.numeric(habitat)) %>% 
        replace(is.na(.), 0) %>%
        mutate(cvi = sqrt( (kelp + seagrass + coldcorals + warmcorals + seamounts + knolls  + hw_slope + habitat)/8) ) 

#Calculate n-1 percentiles of the CVI scores
quantiles= cvi$cvi
quantile(quantiles, c(.25, .50, .75))
range(cvi$cvi)
#Categorize CVI vales

cat_cvi<- cvi %>%
        as.data.frame() %>% 
        mutate(category= cvi) %>% 
        mutate(category= replace(category, category > 1.05 & category <= 1.262252, "Low" ),
               category= replace(category, category > 1.262252 & category <= 1.322876, "Medium"),
               category= replace(category, category > 1.322876 & category <= 1.414214, "High"),
               category= replace(category, category > 1.414214 & category <= 1.84, "Very High"))
# cat_cvi$category <- factor(cat_cvi$category, levels =c())

#Merge CVI with original MPAs SHP

mpa_cvi <- mpa_data %>% 
        select(-c(7:15))


mpa_cvi<- merge(mpa_cvi, cat_cvi[, c("ID", "kelp", "seagrass", "coldcorals", "warmcorals", "seamounts", "hw_slope", "habitat", "cvi", "category")], by = "ID")


## EXPORT SHP and METADATA
st_write(mpa_cvi, "Data/MPA_CVI/MPA_CVI_v.0.0/MPA_CVI_v.0.1_28092021.shp")
writexl::write_xlsx(cat_cvi, "Data/MPA_CVI_metadata_v.0.1_28092021.xlsx")
        